<html>
    <body>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.2/socket.io.slim.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.0.3/pixi.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/p2.js/0.7.1/p2.min.js"></script>
        <script type="text/javascript">
            //(function() {
                var zoom = 50;

                var renderer =  PIXI.autoDetectRenderer(600, 400, {backgroundColor : 0x1099bb});
                var stage = new PIXI.Container();

                stage.position.x =  renderer.width/2;
                stage.position.y =  renderer.height/2;
                stage.scale.x =  zoom;
                stage.scale.y = -zoom;

                document.body.appendChild(renderer.view);

                var world = new p2.World();

                var room = new p2.Body();

                var boxes = [];
                var graphics = [];

                var step = 1;

                var socket = io();
                socket.on('init', function(world_data) {
                    world.gravity = world_data.gravity;

                    world.sleepMode = world_data.sleepMode;
                    world.islandSplit = world_data.islandSplit;

                    for(var i in world_data.room) {
                        var planeShape = new p2.Plane();
                        room.addShape(planeShape, world_data.room[i].position, world_data.room[i].angle);
                    }
                    world.addBody(room);

                    for(var i in world_data.boxes) {
                        var boxShape = new p2.Box({ width: 2, height: 1 });
                        boxes[i] = new p2.Body({
                            mass: 1,
                            position: world_data.boxes[i].position,
                            angle: world_data.boxes[i].angle,
                            velocity: world_data.boxes[i].velocity,
                            angularVelocity: world_data.boxes[i].angularVelocity
                        });
                        boxes[i].addShape(boxShape);

                        world.addBody(boxes[i]);

                        graphics[i] = new PIXI.Graphics();

                        graphics[i].beginFill(0xFF0000);
                        graphics[i].drawRect(-boxShape.width/2, -boxShape.height/2, boxShape.width, boxShape.height);
                        graphics[i].endFill();

                        stage.addChild(graphics[i]);
                    }

                    step = setInterval(function() {
                        world.step(1/60);
                    }, 1000/60);

                    animate();
                });

                socket.on('update', function(world_data) {
                    for(var i in world_data.boxes) {
                        if(world_data.boxes[i] != null) {
                            boxes[i].position = world_data.boxes[i].position;
                            boxes[i].angle = world_data.boxes[i].angle;
                            boxes[i].velocity = world_data.boxes[i].velocity;
                            boxes[i].angularVelocity = world_data.boxes[i].angularVelocity;
                        }
                    }
                });

                renderer.view.addEventListener('mousedown', function(event) {
                    var position = getPhysicsCoord(event);
                    if(event.button === 0)
                        socket.emit('mdown', position);
                });
                renderer.view.addEventListener('touchstart', function(event) {
                    if (event.target == renderer.view) {
                        event.preventDefault();
                    }
                    var position = getMPhysicsCoord(event);
                    socket.volatile.emit('mdown', position);
                });

                renderer.view.addEventListener('mousemove', function(event) {
                    var position = getPhysicsCoord(event);
                    socket.emit('mmove', position);
                });
                renderer.view.addEventListener('touchmove', function(event) {
                    if (event.target == renderer.view) {
                        event.preventDefault();
                    }
                    var position = getMPhysicsCoord(event);
                    socket.emit('mmove', position);
                });

                window.addEventListener('mouseup', function(event) {
                    if(event.button === 0)
                        socket.emit('mup');
                });
                window.addEventListener('touchend', function(event) {
                    if (event.target == renderer.view) {
                        event.preventDefault();
                    }
                    socket.emit('mup');
                });

                function getPhysicsCoord(mouseEvent){
                    var rect = renderer.view.getBoundingClientRect();
                    var x = mouseEvent.clientX - rect.left;
                    var y = mouseEvent.clientY - rect.top;
                    x = (x - renderer.view.width / 2) / stage.scale.x;
                    y = (y - renderer.view.height / 2) / stage.scale.y;
                    return [x, y];
                }

                function getMPhysicsCoord(touchEvent){
                    var rect = renderer.view.getBoundingClientRect();
                    var x = touchEvent.touches[0].clientX - rect.left;
                    var y = touchEvent.touches[0].clientY - rect.top;
                    x = (x - renderer.view.width / 2) / stage.scale.x;
                    y = (y - renderer.view.height / 2) / stage.scale.y;
                    return [x, y];
                }

                socket.on('disconnect', function() {
                    clearInterval(step);
                    
                    for(var i in boxes) {
                        world.removeBody(boxes[i]);
                    }
                    boxes.length = 0;

                    for(var i in graphics) {
                        stage.removeChild(graphics[i]);
                    }
                    graphics.length = 0;

                    world.removeBody(room);
                    room = new p2.Body();
                });

                function animate() {
                    requestAnimationFrame(animate);
                    
                    for(var i in boxes) {
                        graphics[i].position.x = boxes[i].position[0];
                        graphics[i].position.y = boxes[i].position[1];
                        graphics[i].rotation   = boxes[i].angle;
                    }

                    renderer.render(stage);
                }

                /*window.onresize = function (event) {
                    var w = window.innerWidth;
                    var h = window.innerHeight;
                    renderer.view.style.width = w + "px";
                    renderer.view.style.height = h + "px";
                    renderer.resize(w,h);
                }*/
            //})();
        </script>
    </body>
</html>
